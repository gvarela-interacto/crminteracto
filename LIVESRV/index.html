<!DOCTYPE html>
<html>
<head>
    <title>Chat System</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f0f0;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 1rem;
            overflow-y: auto;
        }
        .user-info {
            background: #34495e;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        .user-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .user-role {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }
        .groups-section h3 {
            margin-bottom: 1rem;
            color: #ecf0f1;
        }
        .group-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #34495e;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .group-item:hover {
            background: #4a5f7a;
        }
        .group-item.active {
            background: #3498db;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: white;
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-header h2 {
            margin: 0;
            color: #2c3e50;
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        .message {
            background: white;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .message-author {
            font-weight: bold;
            color: #2c3e50;
        }
        .message-role {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            margin-left: 0.5rem;
        }
        .role-administrador { background: #e74c3c; color: white; }
        .role-operador { background: #f39c12; color: white; }
        .role-vendedor { background: #27ae60; color: white; }
        .role-usuario { background: #3498db; color: white; }
        .message-time {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        .message-content {
            color: #2c3e50;
            line-height: 1.4;
        }
        .system-message {
            background: #f8f9fa;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            border-left: 4px solid #17a2b8;
        }
        .input-container {
            background: white;
            padding: 1rem;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 0.5rem;
        }
        #messageInput {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }
        #messageInput:focus {
            border-color: #3498db;
        }
        #sendButton {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        #sendButton:hover {
            background: #2980b9;
        }
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
        }
        .logout-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="user-info">
                <div class="user-name" id="userName">Usuario</div>
                <div class="user-role" id="userRole">Rol</div>
            </div>
            
            <div class="groups-section">
                <h3>Grupos de Chat</h3>
                <div id="groupsList"></div>
            </div>
            
            <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
        </div>
        
        <div class="chat-container">
            <div class="chat-header">
                <h2 id="chatTitle">Selecciona un grupo</h2>
            </div>
            
            <div class="messages-container">
                <ul id="messages"></ul>
            </div>
            
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." autocomplete="off">
                <button id="sendButton">Enviar</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentGroup = null;
        let userData = null;

        // Verificar autenticación
        window.addEventListener('load', () => {
            const storedUserData = localStorage.getItem('userData');
            if (!storedUserData) {
                window.location.href = '/';
                return;
            }
            
            userData = JSON.parse(storedUserData);
            alert("Hola mundo");
            initializeChat();
        });

        function initializeChat() {
            // Mostrar información del usuario
            document.getElementById('userName').textContent = userData.nombre;
            document.getElementById('userRole').textContent = userData.rol.charAt(0).toUpperCase() + userData.rol.slice(1);
            
            // Autenticar socket
            socket.emit('authenticate', userData);
            
            // Mostrar grupos
            showGroups();
            
            // Seleccionar primer grupo por defecto
            if (userData.grupos.length > 0) {
                selectGroup(userData.grupos[0]);
            }
        }

        function showGroups() {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';
            
            userData.grupos.forEach(grupo => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.textContent = formatGroupName(grupo);
                groupItem.onclick = () => selectGroup(grupo);
                groupItem.setAttribute('data-group', grupo);
                groupsList.appendChild(groupItem);
            });
        }

        function formatGroupName(grupo) {
            return grupo.replace('-chat', '').replace('-', ' ').toUpperCase();
        }

        function selectGroup(grupo) {
            currentGroup = grupo;
            
            // Actualizar UI
            document.getElementById('chatTitle').textContent = formatGroupName(grupo);
            
            // Actualizar grupo activo
            document.querySelectorAll('.group-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-group="${grupo}"]`).classList.add('active');
            
            // Limpiar mensajes
            document.getElementById('messages').innerHTML = '';
        }

        // Manejar envío de mensajes
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message && currentGroup) {
                socket.emit('chat message', {
                    msg: message,
                    grupo: currentGroup
                });
                messageInput.value = '';
            }
        }

        // Escuchar eventos del socket
        socket.on('authenticated', (data) => {
            console.log('Autenticado:', data.mensaje);
            addSystemMessage(data.mensaje);
        });

        socket.on('chat-recibido', (data) => {
            if (data.grupo === currentGroup) {
                addMessage(data);
            }
        });

        socket.on('user-connected', (data) => {
            if (data.grupo === currentGroup) {
                addSystemMessage(`${data.nombre} se ha conectado`);
            }
        });

        socket.on('user-disconnected', (data) => {
            if (data.grupo === currentGroup) {
                addSystemMessage(`${data.nombre} se ha desconectado`);
            }
        });

        socket.on('error', (message) => {
            addSystemMessage(`Error: ${message}`);
        });

        socket.on('auth-error', (message) => {
            alert(`Error de autenticación: ${message}`);
            logout();
        });

        function addMessage(data) {
            const messages = document.getElementById('messages');
            const messageElement = document.createElement('li');
            messageElement.className = 'message';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <div>
                        <span class="message-author">${data.usuario}</span>
                        <span class="message-role role-${data.rol}">${data.rol}</span>
                    </div>
                    <span class="message-time">${data.timestamp}</span>
                </div>
                <div class="message-content">${data.mensaje}</div>
            `;
            
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function addSystemMessage(message) {
            const messages = document.getElementById('messages');
            const messageElement = document.createElement('li');
            messageElement.className = 'message system-message';
            messageElement.innerHTML = `<div class="message-content">${message}</div>`;
            
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function logout() {
            localStorage.removeItem('userData');
            window.location.href = '/';
        }
    </script>
</body>
</html>